<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login/Register</title>
    <link rel="icon" href="data:," />
    <link rel="stylesheet" href="/Frontend/login/login-register.css" />
    <link rel="stylesheet" href="/Frontend/loader/global-loader.css" />
    <script src="/Frontend/loader/global-loader.js" defer></script>

    <!-- Back button small styling -->
    <style>
      .back-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        background: transparent;
        border: 1px solid #6b7280;
        color: #e5e7eb;
        padding: 6px 14px;
        border-radius: 999px;
        cursor: pointer;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: background 0.2s, transform 0.1s, border-color 0.2s;
        z-index: 20;
      }
      .back-btn:hover {
        background: #111827;
        border-color: #9ca3af;
        transform: translateY(-1px);
      }
    </style>
  </head>
  <body>
    <!-- BACK BUTTON -->
    <button class="back-btn" onclick="goBack()">‚Üê Back</button>

    <div class="wrapper">
      <!-- =============== LOGIN BOX =============== -->
      <div class="form-box login">
        <h2>Login</h2>
        <form id="loginForm">
          <div class="input-box">
            <input type="email" name="email" required />
            <label>Email</label>
          </div>

          <div class="input-box">
            <input
              type="password"
              name="password"
              required
              autocomplete="current-password"
            />
            <label>Password</label>
          </div>

          <div class="remember-forgot">
            <label><input type="checkbox" /> Remember me</label>
            <a href="#" onclick="showForgot()">Forgot Password?</a>
          </div>

          <button type="submit" class="btn">Login</button>

          <!-- OR & SOCIAL LOGIN BUTTONS -->
          <div
            style="
              margin: 15px 0;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <hr style="flex: 1" />
            <span style="font-size: 12px; color: #aaa">OR</span>
            <hr style="flex: 1" />
          </div>

          <div
            style="
              display: flex;
              flex-direction: column;
              gap: 10px;
              margin-bottom: 10px;
            "
          >
            <!-- GOOGLE LOGIN -->
            <a
              href="http://localhost:5000/auth/google"
              style="
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                width: 100%;
                padding: 10px;
                background: #ffffff;
                color: #444;
                border: 1px solid #ccc;
                border-radius: 5px;
                text-decoration: none;
                font-weight: 500;
                font-size: 14px;
              "
            >
              <img
                src="https://developers.google.com/identity/images/g-logo.png"
                alt="Google"
                style="width: 20px; height: 20px"
              />
              Continue with Google
            </a>
          </div>

          <div class="switch-form">
            Don‚Äôt have an account?
            <a href="#" onclick="showRegister()">Register</a>
          </div>

          <div
            id="loginMessage"
            style="color: red; margin-top: 10px; min-height: 18px"
          ></div>
        </form>
      </div>

      <!-- =============== REGISTER BOX =============== -->
      <div class="form-box register hidden">
        <h2>Register</h2>
        <form id="registerForm">
          <div class="input-box">
            <input type="text" name="username" required />
            <label>Username</label>
          </div>

          <div class="input-box">
            <input type="email" id="regEmail" name="email" required />
            <label>Email</label>
          </div>

          <div class="input-box">
            <input
              type="password"
              name="password"
              id="regPassword"
              required
              autocomplete="new-password"
            />
            <label>Password</label>
          </div>

          <button type="submit" class="btn" id="registerBtn">Register</button>

          <div class="switch-form">
            Already have an account?
            <a href="#" onclick="showLogin()">Login</a>
          </div>

          <div
            id="registerMessage"
            style="color: green; margin-top: 10px; min-height: 18px"
          ></div>
        </form>
      </div>
    </div>

    <!-- =============== FORGOT PASSWORD BOX =============== -->
    <div class="form-box forgot hidden">
      <h2>Reset Password</h2>

      <div class="input-box">
        <input type="email" id="fpEmail" required />
        <label>Email</label>
      </div>

      <button class="btn" type="button" onclick="sendOTP()">Send OTP</button>

      <div class="input-box hidden" id="otpBox">
        <input type="text" id="fpOtp" />
        <label>Enter OTP</label>
      </div>

      <div class="input-box hidden" id="newPassBox">
        <input type="password" id="fpNewPass" />
        <label>New Password</label>
      </div>

      <button
        class="btn hidden"
        type="button"
        id="resetBtn"
        onclick="resetPassword()"
      >
        Reset Password
      </button>

      <div id="fpMsg" style="margin-top: 10px; min-height: 18px"></div>

      <div class="switch-form">
        <a href="#" onclick="showLogin()">Back to Login</a>
      </div>
    </div>

    <!-- Simple back button logic (non-module so onclick can access it) -->
    <script>
      function goBack() {
        if (document.referrer && document.referrer !== "") {
          window.history.back();
        } else {
          window.location.href =
            "http://localhost:5000/Frontend/course/home.html";
        }
      }
    </script>

    <!-- ====================== SCRIPT ====================== -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
      import {
        getAuth,
        RecaptchaVerifier,
        signInWithPhoneNumber,
      } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-analytics.js";

      // ---------- FIREBASE CONFIG ----------
      const firebaseConfig = {
        apiKey: "AIzaSyBAArDl47slDuIt5VlM0AWmwX_xLoMMZ2E",
        authDomain: "mywebapp-62407.firebaseapp.com",
        projectId: "mywebapp-62407",
        storageBucket: "mywebapp-62407.appspot.com",
        messagingSenderId: "106287013769",
        appId: "1:106287013769:web:6a3512652b507cf2d60b58",
        measurementId: "G-Z4BDDSCHLS",
      };

      const app = initializeApp(firebaseConfig);
      try {
        getAnalytics(app);
      } catch (e) {
        console.warn("Analytics error (ignored in dev):", e.message);
      }
      const auth = getAuth(app);
      // ---------- UI SWITCHING ----------
      function showRegister() {
        document.querySelector(".login").classList.add("hidden");
        document.querySelector(".register").classList.remove("hidden");
        document.getElementById("loginMessage").textContent = "";
        document.getElementById("registerMessage").textContent = "";
      }

      function showLogin() {
        document.querySelector(".register").classList.add("hidden");
        document.querySelector(".login").classList.remove("hidden");
        document.getElementById("loginMessage").textContent = "";
        document.getElementById("registerMessage").textContent = "";
      }

      // make available to onclick=""
      window.showRegister = showRegister;
      window.showLogin = showLogin;

      // ---------- EMAIL + PASSWORD LOGIN ----------
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const data = Object.fromEntries(new FormData(event.target).entries());
          const messageDiv = document.getElementById("loginMessage");
          messageDiv.textContent = "";
          const btn = event.target.querySelector("button[type='submit']");
          btn.disabled = true;

          try {
            const res = await fetch("http://localhost:5000/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(data),
            });

            const text = await res.text();
            let result = {};
            try {
              result = JSON.parse(text);
            } catch (err) {
              throw new Error("Invalid JSON from server: " + text);
            }

            if (res.ok && result.success) {
              messageDiv.style.color = "lightgreen";
              messageDiv.textContent = "Login successful! Redirecting...";
              window.location.href = "http://localhost:5173/";
            } else {
              messageDiv.style.color = "red";
              messageDiv.textContent = result.message || "Login failed.";
            }
          } catch (error) {
            console.error(error);
            messageDiv.style.color = "red";
            messageDiv.textContent = "Network error. Please try again.";
          } finally {
            btn.disabled = false;
          }
        });

      // ---------- REGISTER ----------
      document
        .getElementById("registerForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const data = Object.fromEntries(new FormData(event.target).entries());
          const messageDiv = document.getElementById("registerMessage");
          messageDiv.textContent = "";
          const btn = event.target.querySelector("button[type='submit']");
          btn.disabled = true;

          try {
            const res = await fetch("http://localhost:5000/register", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(data),
            });

            const text = await res.text();
            let result = {};
            try {
              result = JSON.parse(text);
            } catch (err) {
              throw new Error("Invalid JSON from server: " + text);
            }

            if (res.ok && result.success) {
              messageDiv.style.color = "lightgreen";
              messageDiv.textContent =
                result.message || "Registered successfully!";
              setTimeout(() => showLogin(), 1500);
            } else {
              messageDiv.style.color = "red";
              messageDiv.textContent = result.message || "Registration failed.";
            }
          } catch (error) {
            console.error(error);
            messageDiv.style.color = "red";
            messageDiv.textContent = "Network error. Please try again.";
          } finally {
            btn.disabled = false;
          }
        });

      function showForgot() {
        document.querySelector(".login").classList.add("hidden");
        document.querySelector(".register").classList.add("hidden");
        document.querySelector(".forgot").classList.remove("hidden");
      }
      window.showForgot = showForgot;

      async function sendOTP() {
        const email = document.getElementById("fpEmail").value;
        const msg = document.getElementById("fpMsg");

        msg.textContent = "";

        const res = await fetch("http://localhost:5000/forgot-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });

        const data = await res.json();

        if (data.success) {
          msg.style.color = "lightgreen";
          msg.textContent = "OTP sent to your email";

          document.getElementById("otpBox").classList.remove("hidden");
          document.getElementById("newPassBox").classList.remove("hidden");
          document.getElementById("resetBtn").classList.remove("hidden");
        } else {
          msg.style.color = "red";
          msg.textContent = data.message;
        }
      }

      async function resetPassword() {
        const email = document.getElementById("fpEmail").value;
        const otp = document.getElementById("fpOtp").value;
        const password = document.getElementById("fpNewPass").value;
        const msg = document.getElementById("fpMsg");

        msg.textContent = "";

        const res = await fetch("http://localhost:5000/reset-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, otp, password }),
        });

        const data = await res.json();

        if (data.success) {
          msg.style.color = "lightgreen";
          msg.textContent =
            "Password reset successful! Redirecting to login...";

          // üî• FINAL FIX
          setTimeout(() => {
            window.location.href = "/login.html";
            // OR: window.location.reload();
          }, 1200);
        } else {
          msg.style.color = "red";
          msg.textContent = data.message || "Reset failed";
        }
      }

      window.sendOTP = sendOTP;
      window.resetPassword = resetPassword;
    </script>
  </body>
</html>
